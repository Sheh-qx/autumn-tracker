<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>秋招简历进度管理器</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-6">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;
    
    const STATUS_OPTIONS = [
      '待投递',
      '已投递',
      '笔试',
      '面试',
      '意向待确认',
      'Offer',
      '已拒绝',
    ];

    const STORAGE_KEY = 'autumn_tracker_v1';
    const TODO_KEY = 'autumn_tracker_todos_v1';

    function TodoBox({ todos, onAdd, onToggle, onDelete }) {
      const [text, setText] = useState('');
      return (
        <div>
          <div className="flex gap-2">
            <input
              value={text}
              onChange={(e) => setText(e.target.value)}
              placeholder="添加待办（如：准备作品集）"
              className="input flex-1"
            />
            <button
              onClick={() => {
                onAdd(text);
                setText('');
              }}
              className="px-4 py-2 bg-indigo-600 text-white rounded"
            >
              添加
            </button>
          </div>
          <ul className="mt-3 max-h-40 overflow-auto space-y-1">
            {todos.map((t) => (
              <li
                key={t.id}
                className="flex items-center justify-between p-1 border rounded"
              >
                <label className="flex items-center gap-2 cursor-pointer flex-1">
                  <input
                    type="checkbox"
                    checked={t.done}
                    onChange={() => onToggle(t.id)}
                    className="cursor-pointer"
                  />
                  <span className={t.done ? 'line-through text-slate-400' : ''}>
                    {t.text}
                  </span>
                </label>
                <button
                  onClick={() => onDelete(t.id)}
                  className="text-red-500 text-xs underline"
                  title="删除待办"
                >
                  删除
                </button>
              </li>
            ))}
          </ul>
        </div>
      );
    }

    function Timeline({ companies }) {
      if (!companies || companies.length === 0)
        return <div className="text-slate-500 mt-2">无时间线数据</div>;
      return (
        <ol className="border-l-2 border-slate-100 ml-4 pl-4 space-y-4 max-h-[40vh] overflow-auto">
          {companies.map((c) => (
            <li key={c.id} className="relative">
              <div className="absolute -left-6 top-1 w-3 h-3 rounded-full bg-indigo-600" />
              <div className="text-sm font-medium">
                {c.date} — {c.name} <span className="text-slate-500">({c.status})</span>
              </div>
              {c.role && (
                <div className="text-xs text-slate-500">
                  {c.role} • {c.industry || '未分类'}
                </div>
              )}
            </li>
          ))}
        </ol>
      );
    }

    function AutumnRecruitmentTracker() {
      const [companies, setCompanies] = useState([]);
      const [filterIndustry, setFilterIndustry] = useState('All');
      const [filterStatus, setFilterStatus] = useState('All');
      const [query, setQuery] = useState('');
      const [showForm, setShowForm] = useState(false);
      const [editId, setEditId] = useState(null);
      const [todos, setTodos] = useState([]);

      const [form, setForm] = useState({
        name: '',
        role: '',
        industry: '',
        status: 'Applied',
        date: new Date().toISOString().slice(0, 10),
        notes: '',
      });

      useEffect(() => {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) setCompanies(JSON.parse(raw));
        const t = localStorage.getItem(TODO_KEY);
        if (t) setTodos(JSON.parse(t));
      }, []);

      useEffect(() => {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(companies));
      }, [companies]);

      useEffect(() => {
        localStorage.setItem(TODO_KEY, JSON.stringify(todos));
      }, [todos]);

      useEffect(() => {
        if (typeof document === 'undefined') return;
        if (document.head.querySelector('#autumn-tracker-style')) return;
        const inputBase = 'w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-1 focus:ring-indigo-200';
        const s = document.createElement('style');
        s.id = 'autumn-tracker-style';
        s.innerHTML = `.input { ${inputBase} }`;
        document.head.appendChild(s);
      }, []);

      function resetForm() {
        setForm({
          name: '',
          role: '',
          industry: '',
          status: 'Applied',
          date: new Date().toISOString().slice(0, 10),
          notes: '',
        });
        setEditId(null);
      }

      function openAdd() {
        resetForm();
        setShowForm(true);
      }

      function saveCompany(e) {
        e && e.preventDefault();
        if (!form.name) return alert('请填写公司名称');

        if (editId) {
          setCompanies((prev) =>
            prev.map((c) => (c.id === editId ? { ...c, ...form } : c))
          );
        } else {
          const id = Date.now().toString();
          setCompanies((prev) => [{ id, ...form }, ...prev]);
        }
        setShowForm(false);
        resetForm();
      }

      function removeCompany(id) {
        if (!window.confirm('确定删除该条记录？')) return;
        setCompanies((prev) => prev.filter((c) => c.id !== id));
      }

      function startEdit(c) {
        setEditId(c.id);
        setForm({
          name: c.name,
          role: c.role,
          industry: c.industry,
          status: c.status,
          date: c.date,
          notes: c.notes || '',
        });
        setShowForm(true);
      }

      function toggleStatusQuick(id) {
        setCompanies((prev) =>
          prev.map((c) => {
            if (c.id !== id) return c;
            const idx = STATUS_OPTIONS.indexOf(c.status);
            const next = STATUS_OPTIONS[Math.min(STATUS_OPTIONS.length - 1, idx + 1)];
            return { ...c, status: next };
          })
        );
      }

      // Derived data
      const industries = Array.from(
        new Set(companies.map((c) => c.industry).filter(Boolean))
      ).sort();

      const filtered = companies
        .filter((c) => {
          if (filterIndustry !== 'All' && c.industry !== filterIndustry) return false;
          if (filterStatus !== 'All' && c.status !== filterStatus) return false;
          if (
            query &&
            !`${c.name} ${c.role} ${c.notes}`
              .toLowerCase()
              .includes(query.toLowerCase())
          )
            return false;
          return true;
        })
        .sort((a, b) => new Date(b.date) - new Date(a.date));

      function stats() {
        const byStatus = {};
        const byIndustry = {};
        companies.forEach((c) => {
          byStatus[c.status] = (byStatus[c.status] || 0) + 1;
          const ind = c.industry || 'Unspecified';
          byIndustry[ind] = (byIndustry[ind] || 0) + 1;
        });
        return { total: companies.length, byStatus, byIndustry };
      }

      function generateSuggestions() {
        const suggestions = [];
        const now = new Date();
        companies.forEach((c) => {
          const d = new Date(c.date);
          const daysSince = Math.floor((now - d) / (1000 * 60 * 60 * 24));
          if (c.status === 'Applied' && daysSince >= 7) {
            suggestions.push({
              id: c.id,
              text: `已投递 ${c.name} ${daysSince} 天，建议：跟进邮件或通过LinkedIn寻找招聘者。`,
            });
          }

          if (c.status === 'Phone Screen' && daysSince >= 14) {
            suggestions.push({
              id: c.id,
              text: `${c.name} 在电话面试后 ${daysSince} 天无进展，建议：发送感谢邮件并询问下一步安排。`,
            });
          }

          if (c.status === 'Interested' && (!c.role || !c.industry)) {
            suggestions.push({
              id: c.id,
              text: `${c.name} 信息不完整，建议补充职位或行业以便后续分类。`,
            });
          }

          if (c.status === 'Offer') {
            suggestions.push({
              id: c.id,
              text: `${c.name} 有 Offer，建议：记录薪资/截止日期并做对比决策要点。`,
            });
          }
        });
        if (companies.length === 0)
          suggestions.push({
            id: 'none',
            text: '尚未添加任何记录，建议先把你已投递和感兴趣的公司罗列进来。',
          });
        return suggestions;
      }

      // Todo handlers
      function addTodo(text) {
        if (!text) return;
        setTodos((prev) => [{ id: Date.now().toString(), text, done: false }, ...prev]);
      }
      
      function toggleTodo(id) {
        setTodos((prev) =>
          prev.map((t) => (t.id === id ? { ...t, done: !t.done } : t))
        );
      }
      
      function delTodo(id) {
        setTodos((prev) => prev.filter((t) => t.id !== id));
      }

      // Export / Import (simple JSON)
      function exportJSON() {
        const data = { companies, todos };
        const blob = new Blob([JSON.stringify(data, null, 2)], {
          type: 'application/json',
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'autumn_tracker_export.json';
        a.click();
        URL.revokeObjectURL(url);
      }

      function importJSON(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const parsed = JSON.parse(e.target.result);
            if (Array.isArray(parsed.companies)) setCompanies(parsed.companies);
            if (Array.isArray(parsed.todos)) setTodos(parsed.todos);
            alert('导入成功');
          } catch (err) {
            alert('导入失败：文件格式不对');
          }
        };
        reader.readAsText(file);
      }

      const s = stats();
      const suggestions = generateSuggestions();

      return (
        <div className="min-h-screen bg-gradient-to-b from-white to-slate-50 p-6">
          <div className="max-w-6xl mx-auto">
            <header className="flex items-center justify-between mb-6">
              <div>
                <h1 className="text-2xl font-extrabold">秋招简历进度管理器</h1>
                <p className="text-sm text-slate-500">
                  记录投递、面试、Offer，按时间线与行业分类查看并获取建议。
                </p>
              </div>
              <div className="flex gap-2">
                <button
                  onClick={openAdd}
                  className="px-4 py-2 bg-indigo-600 text-white rounded-lg shadow"
                >
                  添加公司
                </button>
                <button
                  onClick={exportJSON}
                  className="px-4 py-2 bg-white border rounded-lg"
                >
                  导出
                </button>
                <label className="px-4 py-2 bg-white border rounded-lg cursor-pointer">
                  导入
                  <input
                    type="file"
                    accept="application/json"
                    className="hidden"
                    onChange={(e) => importJSON(e.target.files[0])}
                  />
                </label>
              </div>
            </header>

            <main className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {/* 左侧: 筛选+统计+建议+todo */}
              <section className="col-span-1 bg-white p-4 rounded-2xl shadow-sm">
                <h2 className="font-semibold">筛选与统计</h2>
                <div className="mt-3 space-y-2">
                  <input
                    value={query}
                    onChange={(e) => setQuery(e.target.value)}
                    placeholder="搜索公司 / 职位 / 备注"
                    className="w-full input"
                  />

                  <div className="flex gap-2">
                    <select
                      value={filterIndustry}
                      onChange={(e) => setFilterIndustry(e.target.value)}
                      className="flex-1 input"
                    >
                      <option>All</option>
                      {industries.map((ind) => (
                        <option key={ind}>{ind}</option>
                      ))}
                    </select>
                    <select
                      value={filterStatus}
                      onChange={(e) => setFilterStatus(e.target.value)}
                      className="flex-1 input"
                    >
                      <option>All</option>
                      {STATUS_OPTIONS.map((s) => (
                        <option key={s}>{s}</option>
                      ))}
                    </select>
                  </div>

                  <div className="mt-2 text-sm text-slate-600">
                    <div>
                      总条目：<strong>{s.total}</strong>
                    </div>
                    <div className="mt-2">按状态：</div>
                    <div className="flex flex-wrap gap-2 mt-1">
                      {Object.entries(s.byStatus).map(([k, v]) => (
                        <div key={k} className="px-2 py-1 bg-slate-100 rounded">
                          {k}：{v}
                        </div>
                      ))}
                    </div>
                    <div className="mt-2">按行业：</div>
                    <div className="flex flex-wrap gap-2 mt-1">
                      {Object.entries(s.byIndustry).map(([k, v]) => (
                        <div key={k} className="px-2 py-1 bg-slate-100 rounded">
                          {k}：{v}
                        </div>
                      ))}
                    </div>
                  </div>
                </div>

                <div className="mt-4">
                  <h3 className="font-medium">建议</h3>
                  <ul className="mt-2 space-y-2 text-sm">
                    {suggestions.map((s) => (
                      <li key={s.id} className="p-2 bg-amber-50 rounded">
                        {s.text}
                      </li>
                    ))}
                  </ul>
                </div>

                <div className="mt-4">
                  <h3 className="font-medium">ToDo</h3>
                  <TodoBox todos={todos} onAdd={addTodo} onToggle={toggleTodo} onDelete={delTodo} />
                </div>
              </section>

              {/* 右侧: 时间线与列表视图 */}
              <section className="col-span-1 lg:col-span-2 bg-white p-4 rounded-2xl shadow-sm">
                <div className="flex items-start justify-between">
                  <h2 className="font-semibold">时间线 / 列表</h2>
                  <div className="text-sm text-slate-500">按日期排序（最新在上）</div>
                </div>

                <div className="mt-4 space-y-3 max-h-[50vh] overflow-auto">
                  {filtered.length === 0 && (
                    <div className="text-slate-500">暂无匹配记录。</div>
                  )}
                  {filtered.map((c) => (
                    <div
                      key={c.id}
                      className="p-3 border rounded-lg flex flex-col md:flex-row items-start md:items-center justify-between gap-2"
                    >
                      <div>
                        <div className="font-medium">
                          {c.name}{' '}
                          <span className="text-sm text-slate-400">
                            {c.role ? '· ' + c.role : ''}
                          </span>
                        </div>
                        <div className="text-xs text-slate-500">
                          {c.industry || '未分类'} • {c.date} • {c.notes}
                        </div>
                        <div className="mt-2 flex gap-2 flex-wrap">
                          <span className="px-2 py-1 rounded bg-slate-100 text-sm">
                            {c.status}
                          </span>
                          <button
                            onClick={() => toggleStatusQuick(c.id)}
                            className="text-xs underline"
                          >
                            下一阶段
                          </button>
                          <button
                            onClick={() => startEdit(c)}
                            className="text-xs underline"
                          >
                            编辑
                          </button>
                          <button
                            onClick={() => removeCompany(c.id)}
                            className="text-xs underline text-red-500"
                          >
                            删除
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>

                <div className="mt-6 overflow-auto max-h-[40vh]">
                  <h3 className="font-medium mb-2">时间线视图（简洁）</h3>
                  <Timeline companies={filtered} />
                </div>
              </section>
            </main>

            {/* 添加/编辑表单弹窗 */}
            {showForm && (
              <div className="fixed inset-0 flex items-center justify-center z-50">
                <div
                  className="absolute inset-0 bg-black/30"
                  onClick={() => {
                    setShowForm(false);
                    resetForm();
                  }}
                />
                <form
                  onSubmit={saveCompany}
                  className="relative bg-white rounded-2xl shadow-lg w-full max-w-2xl p-6 z-10"
                >
                  <h3 className="text-lg font-semibold">
                    {editId ? '编辑公司' : '添加公司'}
                  </h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">
                    <input
                      value={form.name}
                      onChange={(e) => setForm({ ...form, name: e.target.value })}
                      placeholder="公司名称"
                      className="input"
                    />
                    <input
                      value={form.role}
                      onChange={(e) => setForm({ ...form, role: e.target.value })}
                      placeholder="职位"
                      className="input"
                    />
                    <input
                      value={form.industry}
                      onChange={(e) => setForm({ ...form, industry: e.target.value })}
                      placeholder="行业（如：游戏/互联网/金融）"
                      className="input"
                    />
                    <select
                      value={form.status}
                      onChange={(e) => setForm({ ...form, status: e.target.value })}
                      className="input"
                    >
                      {STATUS_OPTIONS.map((s) => (
                        <option key={s} value={s}>
                          {s}
                        </option>
                      ))}
                    </select>
                    <input
                      type="date"
                      value={form.date}
                      onChange={(e) => setForm({ ...form, date: e.target.value })}
                      className="input"
                    />
                    <input
                      value={form.notes}
                      onChange={(e) => setForm({ ...form, notes: e.target.value })}
                      placeholder="备注"
                      className="input"
                    />
                  </div>
                  <div className="mt-4 flex justify-end gap-2">
                    <button
                      type="button"
                      onClick={() => {
                        setShowForm(false);
                        resetForm();
                      }}
                      className="px-4 py-2 rounded border"
                    >
                      取消
                    </button>
                    <button
                      type="submit"
                      className="px-4 py-2 rounded bg-indigo-600 text-white"
                    >
                      保存
                    </button>
                  </div>
                </form>
              </div>
            )}
            
            <footer className="mt-6 text-sm text-slate-500">
              小工具说明：使用本地存储保存数据。您可以导出为 JSON 做备份或导入历史记录。
            </footer>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<AutumnRecruitmentTracker />);
  </script>
</body>
</html>
